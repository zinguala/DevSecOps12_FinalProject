- name: copy and deploy cluster
  gather_facts: false
  hosts: web
  vars:
    asnible_python_interpreter: /usr/bin/python3
  
  tasks:
  - name: ensures minikube conf dir exists
    file: 
      path: "/home/{{ansible_user}}/minikube_configs"
      state: directory

  - name: copy minikube deployment config to web
    ansible.builtin.copy:
      src: /etc/minikube_configs/client-deployment-4replicas.yml
      dest: /home/{{ansible_user}}/minikube_configs
      owner: "{{ansible_user}}"
      group: sudo

  - name: copy minikube deployment config to web
    ansible.builtin.copy:
      src: /etc/minikube_configs/client-deployment-service.yml
      dest: /home/{{ansible_user}}/minikube_configs
      owner: "{{ansible_user}}"
      group: sudo

  - name: apply the cluster with kubectl -restart minikube in case of error
    block:
      - name: apply the 4 replicas deployment
        ansible.builtin.shell: kubectl apply -f /home/{{ansible_user}}/minikube_configs/client-deployment-4replicas.yml
    
      - name: apply the 4 replicas service
        ansible.builtin.shell: kubectl apply -f /home/{{ansible_user}}/minikube_configs/client-deployment-service.yml
    rescue:
      - name: restart minikube
        ansible.builtin.shell: minikube start
        
      - name: apply the 4 replicas deployment
        ansible.builtin.shell: kubectl apply -f /home/{{ansible_user}}/minikube_configs/client-deployment-4replicas.yml
    
      - name: apply the 4 replicas service
        ansible.builtin.shell: kubectl apply -f /home/{{ansible_user}}/minikube_configs/client-deployment-service.yml

  - name: check if nginx running if now start the service
    block:
      - name: Check all port numbers are accessible from the current host
        wait_for:
          port: 5005
          state: started         # Port should be open
          delay: 0               # No wait before first check (sec)
          timeout: 5             # Stop checking after timeout (sec)
          ignore_errors: yes
        
    rescue:
      - name: restart nginx service
        ansible.builtin.shell: sudo service nginx start
        

 
